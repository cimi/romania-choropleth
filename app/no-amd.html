<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <link rel="stylesheet" href="styles/main.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
    </head>
    <body>
    <a href="https://github.com/cimi/romania-choropleth"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>

    <div id="demo" class="container" style="margin-top:50px">
        <h1>Diferența de populație (2004 - 1956)<br /> în fiecare din județele României</h1>
        <table id="topThree">
            <caption>Județele cu cea mai mare creștere în populație</caption>
            <thead><tr><th>Nume</th><th>Diferență</th></tr></thead>
        </table>
        <table id="bottomThree">
            <caption>Județele cu cea mai mare scădere în populație</caption>
            <thead><tr><th>Nume</th><th>Diferență</th></tr></thead>
        </table>
        <div id="infobox">
            <p>Mutând cursorul peste oricare județ puteți vedea diferența de populație dintre 1956 și 2004.</p>
            <p>Spectrul de culori reflectă cât de mult a scăzut (roșu) sau crescut (albastru).</p>
        </div>
        <div id="map"></div>
    </div>

    <script id="template" type="text/x-handlebars-template">
        <h2>{{name}}</h2>
        <p>Diferență ({{pop2004}} - {{pop1956}}): <strong>{{formulaResult}}</strong> 
        <br />Rang: {{diffIdx}} (diferență) {{popIdx}} (populație) </p>
    </script>

        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

        <!-- Add your site or application content here -->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="scripts/vendor/jquery.min.js"><\/script>')</script>
    <script src="https://raw.github.com/mbostock/queue/master/queue.js"></script>
    <script src="https://raw.github.com/mbostock/topojson/master/topojson.js"></script>
    <script src="http://cloud.github.com/downloads/wycats/handlebars.js/handlebars-1.0.rc.1.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://raw.github.com/cimi/romania-choropleth/master/app/scripts/romania.js"></script>
    <script>
        // callback that gets executed when the map and data is loaded
        var mapLoaded = function (map) {
          var data = map.getData()
            , tmp = []
            , three = { top: [], bottom: [] };

          $.each(data, function (key, value) {
            tmp.push({id: key, name: value.name, diff: value.formulaResult, pop2004: parseInt(value.pop2004)});
          });

          var setIndex = function (idxName) {
            return function (val, idx) {
              data[val.id][idxName] = 42 - idx;
            }
          }

          tmp.sort(function (a, b) { return a.diff - b.diff });
          tmp.forEach(setIndex('diffIdx'));
          three.bottom = tmp.slice(0, 3);
          three.top = tmp.slice(tmp.length - 3).reverse();

          tmp.sort(function (a, b) { return a.pop2004 - b.pop2004 });
          tmp.forEach(setIndex('popIdx'));

          var tableRowTemplate = Handlebars.compile('<tr><td>{{name}}<td>{{diff}}');
          ['top', 'bottom'].forEach(function (set) {
            three[set].forEach(function (county) {
              $('#' + set + 'Three').append(tableRowTemplate(county));
            });
          });
        };

        var defaultInfoboxContents = $('#infobox').html();
        
        var config = {
          data: {
            datafile: 'population.tsv',
            domain: [-100 * 1000, 100 * 1000],
            formula: 'data.pop2004 - data.pop1956',
            range: ['red', 'steelblue']
          },
          topoJSON: 'romania-topo.json',
          target: '#map',
          infobox: {
            target: '#infobox',
            template: '#template'
          },
          interaction: {
            hilight: {
              callback: function (element, d) {
                $('#infobox').css('background-color', d3.select(element).style('fill'));
              }
            }, unhilight: {
              callback: function (element, d) {
                $('#infobox').html(defaultInfoboxContents);
              }
            }
          },
          callback : mapLoaded
        };
        var map = new Romania(config);
    </script>
</body>
</html>
